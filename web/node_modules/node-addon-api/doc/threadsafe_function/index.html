<!DOCTYPE html>
<html lang="en">
  <head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<meta
  name="description"
  content="Design and implement your programming language and software analysis tools with mathematical rigor."
/>
<meta name="keywords" content="runtime, verification, rv, k" />
<meta name="author" content="IELE Semantics | Runtime Verification Inc" />
<meta name="robots" content="index, follow" />

<!--favicon icon-->
<link rel="icon" type="image/png" href="../../../../../assets/img/favicon.ico" />

<title>IELE Semantics | Runtime Verification Inc</title>

<!-- <base href="/k/" /> -->

<!--web fonts-->
<link
  href="https://fonts.googleapis.com/css?family=Nunito:300,400,600,700,800"
  rel="stylesheet"
/>
<link
  href="https://fonts.googleapis.com/css?family=Lora:400i"
  rel="stylesheet"
/>

<link
  href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"
  rel="stylesheet"
/>

<link href="../../../../../assets/css/index.css" rel="stylesheet" />

<!--[if (gt IE 9) |!(IE)]><!-->
<!--<link rel="stylesheet" href="/assets/vendor/custom-nav/css/effects/fade-menu.css"/>-->
<!-- <link rel="stylesheet" href="../../../../../assets/k/vl-nav/css/effects/slide-menu.css" /> -->
<!--<![endif]-->

  </head>

  <body>
<header
  class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar"
>
  <a class="logo-link" href="../../../../../index.html">
    <img
      class="logo-dark"
      srcset="../../../../../assets/img/iele-logo.png"
      alt="K"
      style="height: 48px"
    />
    Semantic Framework
  </a>
  <ul class="navbar-nav ml-md-auto">
    <li class="nav-item">
      <a
        class="nav-link pl-2 pr-1 mx-1 py-3 my-n2"
        href="https://github.com/runtimeverification/iele-semantics"
        target="_blank"
        rel="noopener"
        aria-label="GitHub"
      >
        <i class="fab fa-github"></i>
      </a>
    </li>
  </ul>
  <a
    class="btn btn-rv-blue d-none d-lg-inline-block mb-3 mb-md-0 ml-md-3"
    href="../../../../../downloads"
    >Download</a
  >
</header>


    <div class="container-fluid">
      <div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 bd-sidebar mb-3">
  <form
    role="search"
    class="bd-search d-flex align-items-center justify-content-between"
  >
    <input
      type="search"
      class="form-control"
      placeholder="Search..."
      aria-label="Search for..."
      autocomplete="false"
      id="search-box"
    />
    <button
      class="btn bd-search-docs-toggle d-md-none p-0 ml-3 collapsed"
      type="button"
      aria-label="Toggle docs navigation"
      style="font-size: 1.4rem"
    >
      <i class="fas fa-bars"></i>
    </button>
  </form>
  <nav class="collapse bd-links" aria-label="Main navigation">
    <div class="bd-toc-item">
      <a class="bd-toc-link" href="../../../../../">Homepage</a>
      <a class="bd-toc-link" href="../../../../../INSTALL">Install</a>
      <a class="bd-toc-link" href="../../../../../Design">Design</a>
    </div>
  </nav>
</div>

        <main
          class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 bd-content"
          role="main"
        >
          <div class="markdown-preview"><html><head></head><body><h1>ThreadSafeFunction</h1>
<p>JavaScript functions can normally only be called from a native addon&apos;s main
thread. If an addon creates additional threads, then node-addon-api functions
that require a <code>Napi::Env</code>, <code>Napi::Value</code>, or <code>Napi::Reference</code> must not be
called from those threads.</p>
<p>When an addon has additional threads and JavaScript functions need to be invoked
based on the processing completed by those threads, those threads must
communicate with the addon&apos;s main thread so that the main thread can invoke the
JavaScript function on their behalf. The thread-safe function APIs provide an
easy way to do this.</p>
<p>These APIs provide the type <code>Napi::ThreadSafeFunction</code> as well as APIs to
create, destroy, and call objects of this type.
<code>Napi::ThreadSafeFunction::New()</code> creates a persistent reference that holds a
JavaScript function which can be called from multiple threads. The calls happen
asynchronously. This means that values with which the JavaScript callback is to
be called will be placed in a queue, and, for each value in the queue, a call
will eventually be made to the JavaScript function.</p>
<p><code>Napi::ThreadSafeFunction</code> objects are destroyed when every thread which uses
the object has called <code>Release()</code> or has received a return status of
<code>napi_closing</code> in response to a call to <code>BlockingCall()</code> or <code>NonBlockingCall()</code>.
The queue is emptied before the <code>Napi::ThreadSafeFunction</code> is destroyed. It is
important that <code>Release()</code> be the last API call made in conjunction with a given
<code>Napi::ThreadSafeFunction</code>, because after the call completes, there is no
guarantee that the <code>Napi::ThreadSafeFunction</code> is still allocated. For the same
reason it is also important that no more use be made of a thread-safe function
after receiving a return value of <code>napi_closing</code> in response to a call to
<code>BlockingCall()</code> or <code>NonBlockingCall()</code>. Data associated with the
<code>Napi::ThreadSafeFunction</code> can be freed in its <code>Finalizer</code> callback which was
passed to <code>ThreadSafeFunction::New()</code>.</p>
<p>Once the number of threads making use of a <code>Napi::ThreadSafeFunction</code> reaches
zero, no further threads can start making use of it by calling <code>Acquire()</code>. In
fact, all subsequent API calls associated with it, except <code>Release()</code>, will
return an error value of <code>napi_closing</code>.</p>
<h2>Methods</h2>
<h3>Constructor</h3>
<p>Creates a new empty instance of <code>Napi::ThreadSafeFunction</code>.</p>
<pre class="hljs"><code>Napi::Function::ThreadSafeFunction();
</code></pre>
<h3>Constructor</h3>
<p>Creates a new instance of the <code>Napi::ThreadSafeFunction</code> object.</p>
<pre class="hljs"><code>Napi::ThreadSafeFunction::ThreadSafeFunction(napi_threadsafe_function tsfn);
</code></pre>
<ul>
<li><code>tsfn</code>: The <code>napi_threadsafe_function</code> which is a handle for an existing
thread-safe function.</li>
</ul>
<p>Returns a non-empty <code>Napi::ThreadSafeFunction</code> instance.</p>
<h3>New</h3>
<p>Creates a new instance of the <code>Napi::ThreadSafeFunction</code> object. The <code>New</code>
function has several overloads for the various optional parameters: skip the
optional parameter for that specific overload.</p>
<pre class="hljs"><code>New(napi_env env,
    <span class="hljs-keyword">const</span> Function&amp; callback,
    <span class="hljs-keyword">const</span> Object&amp; resource,
    ResourceString resourceName,
    <span class="hljs-keyword">size_t</span> maxQueueSize,
    <span class="hljs-keyword">size_t</span> initialThreadCount,
    ContextType* context,
    Finalizer finalizeCallback,
    FinalizerDataType* data);
</code></pre>
<ul>
<li><code>env</code>: The <code>napi_env</code> environment in which to construct the
<code>Napi::ThreadSafeFunction</code> object.</li>
<li><code>callback</code>: The <code>Function</code> to call from another thread.</li>
<li><code>[optional] resource</code>: An object associated with the async work that will be
passed to possible async_hooks init hooks.</li>
<li><code>resourceName</code>: A JavaScript string to provide an identifier for the kind of
resource that is being provided for diagnostic information exposed by the
async_hooks API.</li>
<li><code>maxQueueSize</code>: Maximum size of the queue. <code>0</code> for no limit.</li>
<li><code>initialThreadCount</code>: The initial number of threads, including the main
thread, which will be making use of this function.</li>
<li><code>[optional] context</code>: Data to attach to the resulting <code>ThreadSafeFunction</code>.</li>
<li><code>[optional] finalizeCallback</code>: Function to call when the <code>ThreadSafeFunction</code>
is being destroyed.  This callback will be invoked on the main thread when the
thread-safe function is about to be destroyed. It receives the context and the
finalize data given during construction (if given), and provides an
opportunity for cleaning up after the threads e.g. by calling
<code>uv_thread_join()</code>. It is important that, aside from the main loop thread,
there be no threads left using the thread-safe function after the finalize
callback completes. Must implement <code>void operator()(Env env, DataType* data, Context* hint)</code>, skipping <code>data</code> or <code>hint</code> if they are not provided.
Can be retreived via <code>GetContext()</code>.</li>
<li><code>[optional] data</code>: Data to be passed to <code>finalizeCallback</code>.</li>
</ul>
<p>Returns a non-empty <code>Napi::ThreadSafeFunction</code> instance.</p>
<h3>Acquire</h3>
<p>Add a thread to this thread-safe function object, indicating that a new thread
will start making use of the thread-safe function.</p>
<pre class="hljs"><code>napi_status Napi::ThreadSafeFunction::Acquire()
</code></pre>
<p>Returns one of:</p>
<ul>
<li><code>napi_ok</code>: The thread has successfully acquired the thread-safe function
for its use.</li>
<li><code>napi_closing</code>: The thread-safe function has been marked as closing via a
previous call to <code>Abort()</code>.</li>
</ul>
<h3>Release</h3>
<p>Indicate that an existing thread will stop making use of the thread-safe
function. A thread should call this API when it stops making use of this
thread-safe function. Using any thread-safe APIs after having called this API
has undefined results in the current thread, as it may have been destroyed.</p>
<pre class="hljs"><code>napi_status Napi::ThreadSafeFunction::Release()
</code></pre>
<p>Returns one of:</p>
<ul>
<li><code>napi_ok</code>: The thread-safe function has been successfully released.</li>
<li><code>napi_invalid_arg</code>: The thread-safe function&apos;s thread-count is zero.</li>
<li><code>napi_generic_failure</code>: A generic error occurred when attemping to release
the thread-safe function.</li>
</ul>
<h3>Abort</h3>
<p>&quot;Abort&quot; the thread-safe function. This will cause all subsequent APIs associated
with the thread-safe function except <code>Release()</code> to return <code>napi_closing</code> even
before its reference count reaches zero. In particular, <code>BlockingCall</code> and
<code>NonBlockingCall()</code> will return <code>napi_closing</code>, thus informing the threads that
it is no longer possible to make asynchronous calls to the thread-safe function.
This can be used as a criterion for terminating the thread. Upon receiving a
return value of <code>napi_closing</code> from a thread-safe function call a thread must
make no further use of the thread-safe function because it is no longer
guaranteed to be allocated.</p>
<pre class="hljs"><code>napi_status Napi::ThreadSafeFunction::Abort()
</code></pre>
<p>Returns one of:</p>
<ul>
<li><code>napi_ok</code>: The thread-safe function has been successfully aborted.</li>
<li><code>napi_invalid_arg</code>: The thread-safe function&apos;s thread-count is zero.</li>
<li><code>napi_generic_failure</code>: A generic error occurred when attemping to abort
the thread-safe function.</li>
</ul>
<h3>BlockingCall / NonBlockingCall</h3>
<p>Calls the Javascript function in either a blocking or non-blocking fashion.</p>
<ul>
<li><code>BlockingCall()</code>: the API blocks until space becomes available in the queue.
Will never block if the thread-safe function was created with a maximum queue
size of <code>0</code>.</li>
<li><code>NonBlockingCall()</code>: will return <code>napi_queue_full</code> if the queue was full,
preventing data from being successfully added to the queue.</li>
</ul>
<p>There are several overloaded implementations of <code>BlockingCall()</code> and
<code>NonBlockingCall()</code> for use with optional parameters: skip the optional
parameter for that specific overload.</p>
<pre class="hljs"><code>napi_status Napi::ThreadSafeFunction::BlockingCall(DataType* data, Callback callback) <span class="hljs-keyword">const</span>

napi_status Napi::ThreadSafeFunction::NonBlockingCall(DataType* data, Callback callback) <span class="hljs-keyword">const</span>
</code></pre>
<ul>
<li><code>[optional] data</code>: Data to pass to <code>callback</code>.</li>
<li><code>[optional] callback</code>: C++ function that is invoked on the main thread. The
callback receives the <code>ThreadSafeFunction</code>&apos;s JavaScript callback function to
call as an <code>Napi::Function</code> in its parameters and the <code>DataType*</code> data pointer
(if provided). Must implement <code>void operator()(Napi::Env env, Function jsCallback, DataType* data)</code>, skipping <code>data</code> if not provided. It is not
necessary to call into JavaScript via <code>MakeCallback()</code> because N-API runs
<code>callback</code> in a context appropriate for callbacks.</li>
</ul>
<p>Returns one of:</p>
<ul>
<li><code>napi_ok</code>: The call was successfully added to the queue.</li>
<li><code>napi_queue_full</code>: The queue was full when trying to call in a non-blocking
method.</li>
<li><code>napi_closing</code>: The thread-safe function is aborted and cannot accept more
calls.</li>
<li><code>napi_invalid_arg</code>: The thread-safe function is closed.</li>
<li><code>napi_generic_failure</code>: A generic error occurred when attemping to add to the
queue.</li>
</ul>
<h2>Example</h2>
<pre class="hljs"><code><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;chrono&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;napi.h&gt;</span></span>

<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> Napi;

<span class="hljs-built_in">std</span>::thread nativeThread;
ThreadSafeFunction tsfn;

<span class="hljs-function">Value <span class="hljs-title">Start</span><span class="hljs-params">( <span class="hljs-keyword">const</span> CallbackInfo&amp; info )</span>
</span>{
  Napi::Env env = info.Env();

  <span class="hljs-keyword">if</span> ( info.Length() &lt; <span class="hljs-number">2</span> )
  {
    <span class="hljs-keyword">throw</span> TypeError::New( env, <span class="hljs-string">&quot;Expected two arguments&quot;</span> );
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( !info[<span class="hljs-number">0</span>].IsFunction() )
  {
    <span class="hljs-keyword">throw</span> TypeError::New( env, <span class="hljs-string">&quot;Expected first arg to be function&quot;</span> );
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ( !info[<span class="hljs-number">1</span>].IsNumber() )
  {
    <span class="hljs-keyword">throw</span> TypeError::New( env, <span class="hljs-string">&quot;Expected second arg to be number&quot;</span> );
  }

  <span class="hljs-keyword">int</span> count = info[<span class="hljs-number">1</span>].As&lt;Number&gt;().Int32Value();

  <span class="hljs-comment">// Create a ThreadSafeFunction</span>
  tsfn = ThreadSafeFunction::New(
      env,
      info[<span class="hljs-number">0</span>].As&lt;Function&gt;(),  <span class="hljs-comment">// JavaScript function called asynchronously</span>
      <span class="hljs-string">&quot;Resource Name&quot;</span>,         <span class="hljs-comment">// Name</span>
      <span class="hljs-number">0</span>,                       <span class="hljs-comment">// Unlimited queue</span>
      <span class="hljs-number">1</span>,                       <span class="hljs-comment">// Only one thread will use this initially</span>
      []( Napi::Env ) {        <span class="hljs-comment">// Finalizer used to clean threads up</span>
        nativeThread.join();
      } );

  <span class="hljs-comment">// Create a native thread</span>
  nativeThread = <span class="hljs-built_in">std</span>::thread( [count] {
    <span class="hljs-keyword">auto</span> callback = []( Napi::Env env, Function jsCallback, <span class="hljs-keyword">int</span>* value ) {
      <span class="hljs-comment">// Transform native data into JS data, passing it to the provided </span>
      <span class="hljs-comment">// `jsCallback` -- the TSFN&apos;s JavaScript function.</span>
      jsCallback.Call( {Number::New( env, *value )} );
      
      <span class="hljs-comment">// We&apos;re finished with the data.</span>
      <span class="hljs-keyword">delete</span> value;
    };

    <span class="hljs-keyword">for</span> ( <span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count; i++ )
    {
      <span class="hljs-comment">// Create new data</span>
      <span class="hljs-keyword">int</span>* value = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>( clock() );

      <span class="hljs-comment">// Perform a blocking call</span>
      napi_status status = tsfn.BlockingCall( value, callback );
      <span class="hljs-keyword">if</span> ( status != napi_ok )
      {
        <span class="hljs-comment">// Handle error</span>
        <span class="hljs-keyword">break</span>;
      }

      <span class="hljs-built_in">std</span>::this_thread::sleep_for( <span class="hljs-built_in">std</span>::chrono::seconds( <span class="hljs-number">1</span> ) );
    }

    <span class="hljs-comment">// Release the thread-safe function</span>
    tsfn.Release();
  } );

  <span class="hljs-keyword">return</span> Boolean::New(env, <span class="hljs-literal">true</span>);
}

<span class="hljs-function">Napi::Object <span class="hljs-title">Init</span><span class="hljs-params">( Napi::Env env, Object exports )</span>
</span>{
  exports.Set( <span class="hljs-string">&quot;start&quot;</span>, Function::New( env, Start ) );
  <span class="hljs-keyword">return</span> exports;
}

NODE_API_MODULE( clock, Init )
</code></pre>
<p>The above code can be used from JavaScript as follows:</p>
<pre class="hljs"><code><span class="hljs-keyword">const</span> { start } = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;bindings&apos;</span>)(<span class="hljs-string">&apos;clock&apos;</span>);

start(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;JavaScript callback called with arguments&quot;</span>, <span class="hljs-built_in">Array</span>.from(<span class="hljs-built_in">arguments</span>));
}, <span class="hljs-number">5</span>);
</code></pre>
<p>When executed, the output will show the value of <code>clock()</code> five times at one
second intervals:</p>
<pre class="hljs"><code>JavaScript callback called with arguments [ 84745 ]
JavaScript callback called with arguments [ 103211 ]
JavaScript callback called with arguments [ 104516 ]
JavaScript callback called with arguments [ 105104 ]
JavaScript callback called with arguments [ 105691 ]
</code></pre>
</body></html></div>
        </main>
      </div>
    </div>
<footer class="app-footer text-md-left text-center">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-2 mb-md-0 mb-4">
        <span class="pr-md-5 pr-0 py-3">
          <a href="https://runtimeverification.com" target="_blank">
            <picture>
              <source
                srcset="../../../../../assets/img/rv-logo-dark.png"
                media="(prefers-color-scheme: dark)"
              />
              <img
                class="pr-3 footer-logo"
                src="../../../../../assets/img/rv-logo.png"
                alt="Runtime Verification Inc logo"
              />
            </picture>
          </a>
        </span>
      </div>
      <div class="col-md-6 mb-md-0 mb-4"></div>
      <div class="col-md-4 text-md-right">
        <p class="copyright">
          &copy; 2020 Runtime Verification Inc. All right reserved.
        </p>
      </div>
    </div>
  </div>
</footer>

<script
  async
  src="https://www.googletagmanager.com/gtag/js?id=UA-163311512-1"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", "UA-163311512-1");
</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Typist/1.2/typist.min.js"></script>
    <script src="../../../../../assets/js/index.js"></script>
  </body>
</html>
