<!DOCTYPE html>
<html lang="en">
  <head>
<meta charset="utf-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
/>
<meta
  name="description"
  content="Design and implement your programming language and software analysis tools with mathematical rigor."
/>
<meta name="keywords" content="runtime, verification, rv, k" />
<meta name="author" content="IELE Semantics | Runtime Verification Inc" />
<meta name="robots" content="index, follow" />

<!--favicon icon-->
<link rel="icon" type="image/png" href="../../../assets/img/favicon.ico" />

<title>IELE Semantics | Runtime Verification Inc</title>

<!-- <base href="/k/" /> -->

<!--web fonts-->
<link
  href="https://fonts.googleapis.com/css?family=Nunito:300,400,600,700,800"
  rel="stylesheet"
/>
<link
  href="https://fonts.googleapis.com/css?family=Lora:400i"
  rel="stylesheet"
/>

<link
  href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"
  rel="stylesheet"
/>

<link href="../../../assets/css/index.css" rel="stylesheet" />

<!--[if (gt IE 9) |!(IE)]><!-->
<!--<link rel="stylesheet" href="/assets/vendor/custom-nav/css/effects/fade-menu.css"/>-->
<!-- <link rel="stylesheet" href="../../../assets/k/vl-nav/css/effects/slide-menu.css" /> -->
<!--<![endif]-->

  </head>

  <body>
<header
  class="navbar navbar-expand navbar-dark flex-column flex-md-row bd-navbar"
>
  <a class="logo-link" href="../../../index.html">
    <img
      class="logo-dark"
      srcset="../../../assets/img/iele-logo.png"
      alt="K"
      style="height: 48px"
    />
    Semantic Framework
  </a>
  <ul class="navbar-nav ml-md-auto">
    <li class="nav-item">
      <a
        class="nav-link pl-2 pr-1 mx-1 py-3 my-n2"
        href="https://github.com/runtimeverification/iele-semantics"
        target="_blank"
        rel="noopener"
        aria-label="GitHub"
      >
        <i class="fab fa-github"></i>
      </a>
    </li>
  </ul>
  <a
    class="btn btn-rv-blue d-none d-lg-inline-block mb-3 mb-md-0 ml-md-3"
    href="../../../downloads"
    >Download</a
  >
</header>


    <div class="container-fluid">
      <div class="row flex-xl-nowrap">
<div class="col-12 col-md-3 col-xl-2 bd-sidebar mb-3">
  <form
    role="search"
    class="bd-search d-flex align-items-center justify-content-between"
  >
    <input
      type="search"
      class="form-control"
      placeholder="Search..."
      aria-label="Search for..."
      autocomplete="false"
      id="search-box"
    />
    <button
      class="btn bd-search-docs-toggle d-md-none p-0 ml-3 collapsed"
      type="button"
      aria-label="Toggle docs navigation"
      style="font-size: 1.4rem"
    >
      <i class="fas fa-bars"></i>
    </button>
  </form>
  <nav class="collapse bd-links" aria-label="Main navigation">
    <div class="bd-toc-item">
      <a class="bd-toc-link" href="../../../">Homepage</a>
      <a class="bd-toc-link" href="../../../INSTALL">Install</a>
      <a class="bd-toc-link" href="../../../Design">Design</a>
    </div>
  </nav>
</div>

        <main
          class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 bd-content"
          role="main"
        >
          <div class="markdown-preview"><html><head></head><body><h1>DeAsync.js</h1>
<p><a href="https://www.npmjs.org/package/deasync" target="_blank" rel="noopener"><img src="http://img.shields.io/npm/v/deasync.svg" alt="NPM version"></a></p>
<p>DeAsync turns async function into sync, implemented with a blocking mechanism by calling Node.js event loop at JavaScript layer. The core of deasync is writen in C++.</p>
<h2>Motivation</h2>
<p>Suppose you maintain a library that exposes a function <code>getData</code>. Your users call it to get actual data:<br>
<code>var myData = getData();</code><br>
Under the hood data is saved in a file so you implemented <code>getData</code> using Node.js built-in <code>fs.readFileSync</code>. It&apos;s obvious both <code>getData</code> and <code>fs.readFileSync</code> are sync functions. One day you were told to switch the underlying data source to a repo such as MongoDB which can only be accessed asynchronously. You were also told to avoid pissing off your users, <code>getData</code> API cannot be changed to return merely a promise or demand a callback parameter. How do you meet both requirements?</p>
<p>You may tempted to use <a href="https://github.com/laverdet/node-fibers" target="_blank" rel="noopener">node-fibers</a> or a module derived from it, but node fibers can only wrap async function call into a sync function inside a fiber. In the case above you cannot assume all  callers are inside fibers. On the other hand, if you start a fiber in <code>getData</code> then <code>getData</code> itself will still return immediately without waiting for the async call result. For similar reason ES6 generators introduced in Node v0.11 won&apos;t work either.</p>
<p>What really needed is a way to block subsequent JavaScript from running without blocking entire thread by yielding to allow other events in the event loop to be handled. Ideally the blockage is removed as soon as the result of async function is available. A less ideal but often acceptable alternative is a <code>sleep</code> function which you can use to implement the blockage like <code>while(!done) sleep(100);</code>. It is less ideal because sleep duration has to be guessed. It is important the <code>sleep</code> function not only shouldn&apos;t block entire thread, but also shouldn&apos;t incur busy wait that pegs the CPU to 100%.
</p>
<p>DeAsync supports both alternatives.</p>
<h2>Usages</h2>
<ul>
<li>Generic wrapper of async function with conventional API signature <code>function(p1,...pn,function cb(error,result){})</code>. Returns <code>result</code> and throws <code>error</code> as exception if not null:</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">var</span> deasync = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;deasync&apos;</span>);
<span class="hljs-keyword">var</span> cp = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;child_process&apos;</span>);
<span class="hljs-keyword">var</span> exec = deasync(cp.exec);
<span class="hljs-comment">// output result of ls -la</span>
<span class="hljs-keyword">try</span>{
    <span class="hljs-built_in">console</span>.log(exec(<span class="hljs-string">&apos;ls -la&apos;</span>));
}
<span class="hljs-keyword">catch</span>(err){
    <span class="hljs-built_in">console</span>.log(err);
}
<span class="hljs-comment">// done is printed last, as supposed, with cp.exec wrapped in deasync; first without.</span>
<span class="hljs-built_in">console</span>.log(<span class="hljs-string">&apos;done&apos;</span>);
</code></pre>
<ul>
<li>For async function with unconventional API, for instance <code>function asyncFunction(p1,function cb(res){})</code>, use <code>loopWhile(predicateFunc)</code> where <code>predicateFunc</code> is a function that returns boolean loop condition</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">var</span> done = <span class="hljs-literal">false</span>;
<span class="hljs-keyword">var</span> data;
asyncFunction(p1,<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cb</span>(<span class="hljs-params">res</span>)</span>{
    data = res;
    done = <span class="hljs-literal">true</span>;
});
<span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;deasync&apos;</span>).loopWhile(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{<span class="hljs-keyword">return</span> !done;});
<span class="hljs-comment">// data is now populated</span>
</code></pre>
<ul>
<li>Sleep (a wrapper of setTimeout)</li>
</ul>
<pre class="hljs"><code><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">SyncFunction</span>(<span class="hljs-params"></span>)</span>{
  <span class="hljs-keyword">var</span> ret;
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
      ret = <span class="hljs-string">&quot;hello&quot;</span>;
  },<span class="hljs-number">3000</span>);
  <span class="hljs-keyword">while</span>(ret === <span class="hljs-literal">undefined</span>) {
    <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;deasync&apos;</span>).sleep(<span class="hljs-number">100</span>);
  }
  <span class="hljs-comment">// returns hello with sleep; undefined without</span>
  <span class="hljs-keyword">return</span> ret;    
}
</code></pre>
<h2>Installation</h2>
<p>Except on a few <a href="https://github.com/abbr/deasync-bin" target="_blank" rel="noopener"> platforms + Node version combinations</a> where binary distribution is included, DeAsync uses node-gyp to compile C++ source code so you may need the compilers listed in <a href="https://github.com/TooTallNate/node-gyp" target="_blank" rel="noopener">node-gyp</a>. You may also need to <a href="https://github.com/TooTallNate/node-gyp/wiki/Updating-npm&apos;s-bundled-node-gyp" target="_blank" rel="noopener">update npm&apos;s bundled node-gyp</a>.</p>
<p>To install, run</p>
<p><code>npm install deasync</code></p>
<h2>Recommendation</h2>
<p>Unlike other (a)sync js packages that mostly have only syntactic impact, DeAsync also changes code execution sequence. As such, it is intended to solve niche cases like the above one. If all you are facing is syntatic problem such as callback hell, using a less drastic package implemented in pure js is recommended.</p>
<h2>Support</h2>
<p>Pull requests and issue reporting are welcome. For issues to be considered by maintainer</p>
<ol>
<li>they must be reproducible</li>
<li>there must be evidence the issue is related to DeAsync</li>
</ol>
<p>To that end, the issue should contain platform information, error message relevant to DeAsync, and preferably code snippet. If code snippet is supplied, it must be self-contained, i.e. independent from your runtime environment or other modules not explictly specified via <code>require</code> in the code snippet.</p>
<h2>License</h2>
<p>The MIT License (MIT)</p>
<p>Copyright (c) 2015</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the &quot;Software&quot;), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.</p>
</body></html></div>
        </main>
      </div>
    </div>
<footer class="app-footer text-md-left text-center">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-2 mb-md-0 mb-4">
        <span class="pr-md-5 pr-0 py-3">
          <a href="https://runtimeverification.com" target="_blank">
            <picture>
              <source
                srcset="../../../assets/img/rv-logo-dark.png"
                media="(prefers-color-scheme: dark)"
              />
              <img
                class="pr-3 footer-logo"
                src="../../../assets/img/rv-logo.png"
                alt="Runtime Verification Inc logo"
              />
            </picture>
          </a>
        </span>
      </div>
      <div class="col-md-6 mb-md-0 mb-4"></div>
      <div class="col-md-4 text-md-right">
        <p class="copyright">
          &copy; 2020 Runtime Verification Inc. All right reserved.
        </p>
      </div>
    </div>
  </div>
</footer>

<script
  async
  src="https://www.googletagmanager.com/gtag/js?id=UA-163311512-1"
></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag() {
    dataLayer.push(arguments);
  }
  gtag("js", new Date());
  gtag("config", "UA-163311512-1");
</script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Typist/1.2/typist.min.js"></script>
    <script src="../../../assets/js/index.js"></script>
  </body>
</html>
